<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocioMatch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
   <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <!-- HEADER -->
    <header>
        <div class="container d-flex justify-content-between align-items-center py-3">
            <div class="d-flex align-items-center gap-4">
                <h4 class="text-primary fw-bold m-0">‚öΩ SocioMatch</h4>
                <nav class="d-none d-md-flex gap-3">
                    <a href="iniciosesion.html" class="btn btn-link text-decoration-none active">Inicio de sesion</a>
                    <a href="grupo.html" class="btn btn-link text-decoration-none">Crear grupo</a>
                    <a href="metas.html" class="btn btn-link text-decoration-none">Metas Diarias</a>
                    <a href="predicciones.html" class="btn btn-link text-decoration-none">Predicciones</a>
                    <a href="registro.html" class="btn btn-link text-decoration-none">Registro</a>
                </nav>
            </div>

            <div class="d-flex align-items-center gap-3">
                <input type="text" class="form-control form-control-sm d-none d-sm-block" style="width:200px;"
                    placeholder="Buscar...">

                <div class="points-badge">
                    ‚≠ê <span id="userPoints">0</span>
                </div>

                <img src="img/usuario-generico.png" alt="perfil" class="rounded-circle"
                    style="width:40px; height:40px; object-fit:cover;" id="profileImg">

                <button id="btnCerrarSesion" class="btn btn-outline-danger btn-sm" style="display:none;">
                    Cerrar sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <aside class="col-lg-2 d-none d-lg-block sidebar">
                <h6 class="text-muted">Selecciones</h6>
                <button class="btn btn-light mb-2">üá≤üáΩ M√©xico</button>
                <button class="btn btn-light mb-2">üá¶üá∑ Argentina</button>
                <button class="btn btn-light mb-2">üáßüá∑ Brasil</button>
                <button class="btn btn-light mb-2">üá™üá∏ Espa√±a</button>
                <button class="btn btn-light mb-2">üá´üá∑ Francia</button>
                <button class="btn btn-light mb-2">üá©üá™ Alemania</button>
            </aside>

            <!-- Partidos y amigos -->
            <section class="col-lg-7">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h6 class="fw-bold">Partidos en directo</h6>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                    <div>
                                        <p class="m-0">Brasil vs Espa√±a</p>
                                        <small class="text-muted">Mundial ‚Ä¢ 2025-11-21</small>
                                    </div>
                                    <div class="text-end">
                                        <p class="fw-bold m-0">1 - 1</p>
                                        <small>72'</small><br>
                                        <button class="btn btn-sm btn-primary mt-1">Ver juntos</button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center py-2">
                                    <div>
                                        <p class="m-0">Francia vs Alemania</p>
                                        <small class="text-muted">Mundial ‚Ä¢ 2025-11-21</small>
                                    </div>
                                    <div class="text-end">
                                        <p class="fw-bold m-0">0 - 0</p>
                                        <small>20'</small><br>
                                        <button class="btn btn-sm btn-primary mt-1">Ver juntos</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- amigos con b√∫squeda y chat -->
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h6 class="fw-bold">Amigos</h6>

                            <!-- Buscador -->
                            <input type="text" id="searchUser" class="form-control mb-2" placeholder="Buscar usuario por username">

                            <!-- Resultados de b√∫squeda -->
                            <div id="searchResults" class="mb-2"></div>

                            <!-- Lista de amigos -->
                            <div id="friendsList" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Detalles y Chat -->
            <aside class="col-lg-3">
                <div class="card p-3 mb-3">
                    <h6 class="fw-bold">Espa√±a</h6>
                    <div class="alert alert-danger p-2 mt-2">
                        <strong>PARTIDO EN CURSO</strong><br>
                        Brasil vs Espa√±a<br>
                        1 - 1 ‚Ä¢ 72'<br>
                        <button class="btn btn-sm btn-primary mt-1">Ver juntos</button>
                    </div>
                </div>
                <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold m-0">Chat</h6>
        <div class="d-flex align-items-center gap-2">
            <!-- Bot√≥n de c√°mara -->
            <button id="btnVideollamada" class="btn btn-outline-primary btn-sm rounded-circle">
                <i class="bi bi-camera-video-fill"></i>
            </button>

            <!-- Nuevo bot√≥n "+" -->
            <button id="btnOpcionesChat" class="btn btn-outline-success btn-sm rounded-circle">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </div>

    <div class="chat-box mb-2"></div>
    <div class="input-group">
        <input type="text" class="form-control" placeholder="Selecciona un amigo para chatear">
        <button class="btn btn-primary">Enviar</button>
    </div>
</div>


                <div id="videoPopup" class="video-popup" style="display:none;">
                    <div class="video-content">
                        <button id="closePopup" class="btn btn-sm btn-danger mb-2">Cerrar</button>
                        <h5 class="text-center text-primary">Videollamada</h5>
                        <div class="d-flex gap-2 flex-wrap justify-content-center">
                            <video id="myVideo" autoplay playsinline muted class="rounded border"
                                style="width:45%; min-width:200px;"></video>
                            <video id="friendVideo" autoplay playsinline class="rounded border"
                                style="width:45%; min-width:200px;"></video>
                        </div>
                    </div>
                </div>

            </aside>
        </div>
    </div>

    <footer class="text-center text-muted small py-4">
        SocioMatch ‚Ä¢ Quinela + chat con amigos
    </footer>

    <script>
        // Videollamada
        const btnVideollamada = document.getElementById("btnVideollamada");
        const videoPopup = document.getElementById("videoPopup");
        const closePopup = document.getElementById("closePopup");
        const myVideo = document.getElementById("myVideo");

        btnVideollamada.addEventListener("click", async () => {
            videoPopup.style.display = "flex";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                myVideo.srcObject = stream;
            } catch (err) {
                alert("No se pudo acceder a la c√°mara/micr√≥fono: " + err);
            }
        });

        closePopup.addEventListener("click", () => {
            videoPopup.style.display = "none";
            if (myVideo.srcObject) {
                myVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            myVideo.srcObject = null;
        });

        // Manejo de usuario logueado / cierre de sesi√≥n
        document.addEventListener("DOMContentLoaded", async () => {
            const user = JSON.parse(localStorage.getItem('usuario'));

            const userPoints = document.getElementById('userPoints');
            const profileImg = document.getElementById('profileImg');
            const loginBtn = document.querySelector('nav a[href="iniciosesion.html"]');
            const registerBtn = document.querySelector('nav a[href="registro.html"]');
            const btnCerrarSesion = document.getElementById('btnCerrarSesion');

            if (user) {
                userPoints.textContent = user.puntos || 0;
                profileImg.src = user.img_p ? `data:image/png;base64,${user.img_p}` : 'img/image1.png';

                if (loginBtn) loginBtn.remove();
                if (registerBtn) registerBtn.remove();

                btnCerrarSesion.style.display = 'inline-block';
            } else {
                userPoints.textContent = 0;
                profileImg.src = 'img/usuario-generico.png';
                btnCerrarSesion.style.display = 'none';
            }

            btnCerrarSesion.addEventListener('click', () => {
                localStorage.removeItem('usuario');
                location.reload();
            });

            

            // ---------- amigos y chat con DB real ----------
            const searchInput = document.getElementById('searchUser');
            const searchResults = document.getElementById('searchResults');
            const friendsList = document.getElementById('friendsList');
            const chatBox = document.querySelector('.chat-box');
            const input = document.querySelector('.input-group input');
            const sendBtn = document.querySelector('.input-group button');

            let friends = [];
            let chats = {};

            async function renderFriends() {
                if(!user) return;

                const res = await fetch(`https://or-internet.onrender.com/amigos/${user.ID_usuario}`);
                friends = await res.json();

                friendsList.innerHTML = '';
                friends.forEach(f => {
                    const div = document.createElement('div');
                    div.classList.add('d-flex','justify-content-between','align-items-center','border-bottom','py-2');
                    div.innerHTML = `
                        <div>
                            <img src="${f.img_p || 'img/usuario-generico.png'}" class="rounded-circle me-2" style="width:30px;height:30px;object-fit:cover;">
                            ${f.Username} <small class="text-muted">Amigo</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary btnMessage">mensaje</button>
                        </div>
                    `;
                    friendsList.appendChild(div);

                    div.querySelector('.btnMessage').addEventListener('click', () => {
  openChat(f.Username, f.ID_USUARIO); // ahora enviamos el id
});

                });
            }

           // üîç Buscar usuarios en la BD y mostrar bot√≥n "Agregar"
searchInput.addEventListener('input', async () => {
  const query = searchInput.value.trim();
  searchResults.innerHTML = '';
  if (!query) return;

  try {
    const res = await fetch(`https://or-internet.onrender.com/usuarios?q=${encodeURIComponent(query)}`);
    const users = await res.json();

    if (!Array.isArray(users) || users.length === 0) {
      searchResults.innerHTML = `<p class="text-muted small">No se encontraron usuarios</p>`;
      return;
    }

    users.forEach(u => {
      // üß† Evita mostrarte a ti misma
      if (u.ID_USUARIO === user.id) return;

      // üß† Evita mostrar amigos que ya tienes
      if (friends.some(f => f.ID_USUARIO === u.ID_USUARIO)) return;

      const div = document.createElement('div');
      div.classList.add('d-flex','justify-content-between','align-items-center','border','p-1','mb-1','rounded');
      div.innerHTML = `
        <div class="d-flex align-items-center">
          <img src="${u.img_p ? `data:image/png;base64,${u.img_p}` : 'img/usuario-generico.png'}"
            class="rounded-circle me-2" style="width:30px;height:30px;object-fit:cover;">
          <span>${u.Username}</span>
        </div>
        <button class="btn btn-sm btn-primary">Agregar</button>
      `;
      searchResults.appendChild(div);

      // üß© Bot√≥n "Agregar amigo"
      div.querySelector('button').addEventListener('click', async () => {
        try {
          const resAdd = await fetch('https://or-internet.onrender.com/agregar-amigo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              usuario_id: user.id,     // üëà tu usuario logueado
              amigo_id: u.ID_USUARIO   // üëà el usuario encontrado
            })
          });

          const data = await resAdd.json();
          if (resAdd.ok) {
            alert('‚úÖ Amigo agregado correctamente');
            renderFriends(); // refresca la lista
            searchResults.innerHTML = '';
            searchInput.value = '';
          } else {
            alert('‚ö†Ô∏è ' + (data.msg || 'Error al agregar amigo'));
          }
        } catch (err) {
          console.error('‚ùå Error al conectar con el servidor:', err);
          alert('No se pudo conectar con el servidor.');
        }
      });
    });
  } catch (err) {
    console.error('‚ùå Error en la b√∫squeda:', err);
    searchResults.innerHTML = `<p class="text-danger small">Error al cargar usuarios</p>`;
  }
});


            function openChat(friendUsername) {
                chats = JSON.parse(localStorage.getItem('chats')) || {};
                if(!chats[friendUsername]) chats[friendUsername] = [];
                chatBox.innerHTML = '';
                chats[friendUsername].forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-message ' + (msg.sent ? 'sent' : 'received');
                    div.textContent = msg.text;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;

                input.placeholder = `Escribe un mensaje a ${friendUsername}...`;

                sendBtn.onclick = () => {
                    const text = input.value.trim();
                    if(!text) return;
                    chats[friendUsername].push({ text, sent: true });
                    localStorage.setItem('chats', JSON.stringify(chats));

                    const div = document.createElement('div');
                    div.className = 'chat-message sent';
                    div.textContent = text;
                    chatBox.appendChild(div);
                    input.value = '';
                    chatBox.scrollTop = chatBox.scrollHeight;

                    setTimeout(() => {
                        const reply = { text: "¬°Genial! üòé", sent: false };
                        chats[friendUsername].push(reply);
                        localStorage.setItem('chats', JSON.stringify(chats));
                        const rDiv = document.createElement('div');
                        rDiv.className = 'chat-message received';
                        rDiv.textContent = reply.text;
                        chatBox.appendChild(rDiv);
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }, 1000 + Math.random() * 2000);
                };
            }

            renderFriends();
        });
    </script>
 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io('https://sociomatch-backend.onrender.com');
  const user = JSON.parse(localStorage.getItem('usuario')); // ‚Üê de tu login

  // 1Ô∏è‚É£ Registrar usuario al conectarse
  socket.emit('registrarUsuario', user.id);

  // 2Ô∏è‚É£ Recibir mensajes en tiempo real
  socket.on('recibirMensaje', (msg) => {
    if (msg.de === currentChatId) {
      mostrarMensaje(msg.texto, false);
    }
  });

  // 3Ô∏è‚É£ Enviar mensajes privados
  function enviarMensajePrivado(destinatarioId, texto) {
    socket.emit('mensajePrivado', {
      de: user.id,
      para: destinatarioId,
      texto
    });
  }

  // üëá tus elementos del chat
  const input = document.querySelector('.input-group input');
  const sendBtn = document.querySelector('.input-group button');
  const chatBox = document.querySelector('.chat-box');
  let currentChatId = null; // se actualiza al abrir chat con alguien

  function openChat(friendUsername, friendId) {
    currentChatId = friendId;
    chatBox.innerHTML = '';
    input.placeholder = `Escribe un mensaje a ${friendUsername}...`;
    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (!text) return;
      enviarMensajePrivado(friendId, text);
      mostrarMensaje(text, true);
      input.value = '';
    };
  }

  // Mostrar mensajes en pantalla
  function mostrarMensaje(text, enviado) {
    const div = document.createElement('div');
    div.className = 'chat-message ' + (enviado ? 'sent' : 'received');
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
</script>

</body>
</html>
